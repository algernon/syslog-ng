#! /usr/bin/make -f
## debian/rules file for syslog-ng 3.3+
## (C) 2011 Gergely Nagy <algernon@madhouse-project.org>
##
## Released under the GPLv3+, see /usr/share/common-licenses/GPL-3 on
## Debian systems.

##
#* Environment setup
#
# If DEB_BUILD_OPTIONS has "debug" in it, we want to pass
# --enable-debug to configure.
#
# We also want to build in a separate build directory:
# debian/build-tree, because it's just so much easier to ignore files
# in there.
#
# By the way, if one wants to pass extra flags to configure, that can
# be done with EXTRA_CONFIGURE_OPTS, we don't override it, only append
# to it.
##
ifneq (,$(filter debug,$(DEB_BUILD_OPTIONS)))
	EXTRA_CONFIGURE_OPTS += --enable-debug
endif

export DH_OPTIONS += -O-Bdebian/build-tree

# For my own sanity, when debian/rules is ran without any argument,
# display something meaningful, instead of just running the first
# override.
help:
	dh $@

##
#* Overrides for dh_auto*
##

# Autoreconf needs two things:
# - m4 directories for the submodules, because otherwise it can
#   randomly fail.
# - We need to call autogen.sh instead of autoreconf.
override_dh_autoreconf:
	install -d lib/ivykis/m4 modules/afmongodb/libmongo-client/m4
	skip_git=1 dh_autoreconf sh ./autogen.sh

# Oh, the joys of configure!
# We pass down all appropriate options, along with EXTRA_CONFIGURE_OPTS.
# This also sets SOURCE_REVISION to the debian package version.
override_dh_auto_configure:
	SOURCE_REVISION=$(shell dpkg-parsechangelog | sed -n "/^Version:/s/^Version: /debian\//p") \
	dh_auto_configure -- \
		--prefix=/usr \
		--mandir=/usr/share/man \
		--sysconfdir=/etc/syslog-ng \
		--localstatedir=/var/lib/syslog-ng \
		--datadir=/usr/share/syslog-ng \
		\
		--enable-dynamic-linking \
		--enable-ssl \
		--enable-spoof-source \
		--enable-tcp-wrapper \
		--enable-sql \
		--enable-mongodb \
		--enable-json \
		--disable-systemd \
		\
		--with-libmongo-client=system \
		--with-ivykis=internal \
		--with-json=json-c \
		\
		--with-module-dir='$${exec_prefix}/lib/syslog-ng/$${VERSION}' \
		--with-default-modules="affile,afprog,afsocket,afuser,basicfuncs,csvparser,dbparser,syslogformat" \
		\
		${EXTRA_CONFIGURE_OPTS}

# Tests. While tests are good, they're quite costy, and I'm not
# convinced they'd run on the buildds at all. Therefore, they're
# disabled.
override_dh_auto_test:

# Cleaning is another fun thing: make distclean will not remove
# everything we want to remove (ie, everything generated, no
# exceptions). So we do a bit of finding and remove a few things it
# missed. We also remove the m4 directories we created for autoreconf
# earlier.
override_dh_auto_clean:
	dh_auto_clean
	find . \( -name 'Makefile.in' -or \
		  -name 'aclocal.m4' -or \
		  -name 'configure' -or \
		  -name 'depcomp' -or -name 'missing' -or \
		  -name 'install-sh' -or -name 'ltmain.sh' -or \
		  -name 'ylwrap' -or \
		  -regex '.*/config\.\(sub\|guess\|h\.in\)' \) \
	     -exec rm '{}' \;
	rm -f m4/lt*.m4 m4/libtool.m4 m4/pkg.m4
	rm -rf lib/ivykis/m4 modules/afmongodb/libmongo-client/m4

# We also want to install ivykis headers and whatnot, so override
# _auto_install, and do it too.
# However, we do not want iv_examples.3 installed..
override_dh_auto_install:
	dh_auto_install
	${MAKE} -C debian/build-tree/lib/ivykis install DESTDIR=$(CURDIR)/debian/tmp
	rm -f debian/tmp/usr/share/man/man3/iv_examples.*

##
#* Overrides for other debhelper commands
#
# Below are overrides for individual debhelper commands.
##

# Upstream installs the merge-grammar.pl as data, thus not
# executable. Yet, it needs to be, since the Makefiles that upstream
# also installs expect it so.
#
# So we simply flip a few bits after dh_install, and we're good to go!
override_dh_install:
	dh_install
ifneq (,$(filter libsyslog-ng-dev,$(shell dh_listpackages)))
	chmod +x debian/libsyslog-ng-dev/usr/share/syslog-ng/tools/merge-grammar.pl
endif

# Install the NEWS file as upstream changelog.
# Rationale: the ChangeLog file is an old artifact from the Arch
# times. It is not updated, and is obsolete.
override_dh_installchangelogs:
	dh_installchangelogs NEWS

# Init files and whatnot were moved to syslog-ng-core, but we want to
# retain the old filenames. Same goes for logrotate stuff.
override_dh_installinit:
	dh_installinit -R --name syslog-ng -- defaults 10 90

override_dh_installlogrotate:
	dh_installlogrotate --name syslog-ng

override_dh_installlogcheck:
	dh_installlogcheck --name syslog-ng
	for f in $$(find debian/syslog-ng-core/etc/logcheck -type f -name 'syslog-ng-core'); do \
		mv $$f $$(dirname $$f)/syslog-ng; \
	done

# dh_makeshlibs wants to be clever and treat plugins as shared libs.
# Slap it in the face, and tell it not to.
override_dh_makeshlibs:
	dh_makeshlibs -Xusr/lib/syslog-ng

# Compress the .debs with xz, it reduces the size of syslog-ng-core by
# about 40%.
override_dh_builddeb:
	dh_builddeb -- -Zxz

##
#* Other, non-override targets
##

# Dummy build thingy, to work around upstream build/ dir.
build: build-stamp
build-stamp:
.PHONY: build-stamp

# We get the original source by git archiving syslog-ng and all
# submodules, then tarring up the result, and compressing it.
get-orig-source: UPSTREAMVERSION=$(shell git tag | sort | tail -n 1 | sed -e 's/^v//')
get-orig-source:
	git submodule update --init
	install -d debian/orig-source
	git archive "v${UPSTREAMVERSION}" --format tar --prefix=syslog-ng/ | tar -C debian/orig-source -xf -
	(cd lib/ivykis; git archive HEAD --format tar --prefix=syslog-ng/lib/ivykis/) | tar -C debian/orig-source -xf -
	(cd modules/afmongodb/libmongo-client; git archive HEAD --format tar --prefix=syslog-ng/modules/afmongodb/libmongo-client/) | tar -C debian/orig-source -xf -
	tar -C debian/orig-source -cf - syslog-ng | xz -9 >../syslog-ng_${UPSTREAMVERSION}.orig.tar.xz
	rm -rf debian/orig-source

# And for the rest, there is debhelper!
%:
	dh $@ --with autoreconf
